use std::env;

use clap::ArgMatches;
use handlebars::Handlebars;
use serde::{Deserialize, Serialize};

use crate::core::UserConfig;
use crate::utils::{read_config_from_files, write_file};

#[derive(Debug, Clone, Deserialize, Serialize)]
struct GitHubTeamMembers {
    pub team: String,
    pub members: Vec<UserConfig>,
}

/**
 * Generate GitHub terraform configs that configure members of the
 * organization and team membership. We use terraform instead of calling out the
 * api ourselves because the diffs of the files after changes are more readable
 * than not having that functionality at all.
 *
 * This command uses the users.toml file for information.
 */
pub fn cmd_teams_run(cli_matches: &ArgMatches) {
    // Get the config.
    let config = read_config_from_files(cli_matches);

    // Get the current working directory.
    let path = env::current_dir().unwrap().join("terraform/github/");

    // Initialize handlebars.
    let handlebars = Handlebars::new();

    // Generate the members of the org file.
    let rendered = handlebars
        .render_template(
            &TEMPLATE_TERRAFORM_GITHUB_ORG_MEMBERSHIP,
            &config.users,
        )
        .unwrap();

    // Join it with the directory to save the files in.
    let file = path.join("generated.organization-members.tf");

    write_file(file, rendered);

    // Generate the members of each team.
    // TODO: don't hard code these
    let teams = vec!["all", "eng", "friends-of-oxide"];
    for team in teams {
        // Build the members array.
        let mut members: Vec<UserConfig> = Default::default();
        for (_, user) in config.users.clone() {
            match user.clone().groups {
                Some(groups) => {
                    if groups.contains(&team.to_string()) {
                        members.push(user.clone());
                    }
                }
                None => continue,
            }
        }

        // Generate the members of the team file.
        let rendered = handlebars
            .render_template(
                &TEMPLATE_TERRAFORM_GITHUB_TEAM_MEMBERSHIP,
                &GitHubTeamMembers {
                    team: team.to_string(),
                    members: members,
                },
            )
            .unwrap();

        // Join it with the directory to save the files in.
        let file = path
            .join(format!("generated.team-members-{}.tf", team.to_string()));

        write_file(file, rendered);
    }

    // TODO: Generate files for the repositories.
    // Initialize the clients for the config.
    // let mut client = Client::new(config);
}

/// Template for terraform GitHub org membership.
static TEMPLATE_TERRAFORM_GITHUB_ORG_MEMBERSHIP: &'static str = r#"# THIS IS A GENERATED FILE, DO NOT EDIT THIS FILE DIRECTLY.

# Define the members of the organization.
{{#each this}}{{#if this.github}}
# Add @{{this.github}} to the organization.
resource "github_membership" "{{this.github}}" {
  username = "{{this.github}}"
  role     = "{{#if this.is_super_admin}}admin{{else}}member{{/if}}"
}
{{/if}}{{/each}}
"#;

/// Template for terraform GitHub team membership.
static TEMPLATE_TERRAFORM_GITHUB_TEAM_MEMBERSHIP: &'static str = r#"# THIS IS A GENERATED FILE, DO NOT EDIT THIS FILE DIRECTLY.

# Define the members of the {{this.team}} team.
{{#each this.members}}{{#if this.github}}
# Add @{{this.github}} to {{../team}}.
resource "github_team_membership" "{{../team}}-{{this.github}}" {
  team_id  = github_team.{{../team}}.id
  username = "{{this.github}}"
  role     = "{{#if this.is_super_admin}}maintainer{{else}}member{{/if}}"
}
{{/if}}{{/each}}
"#;
